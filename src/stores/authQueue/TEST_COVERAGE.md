# AuthQueue 測試覆蓋報告

## 測試概述

為 `src/utils/authQueue/index.ts` 創建了全面的測試套件，覆蓋了所有核心功能。

## 測試覆蓋的功能

### 1. 基本狀態管理
- ✅ 初始狀態驗證
- ✅ `enqueueTask` - 任務入隊
- ✅ `clearQueue` - 清空佇列
- ✅ `size` - 獲取佇列大小
- ✅ `reset` - 重置所有狀態

### 2. 任務拒絕機制
- ✅ `rejectAllQueue` - 拒絕所有佇列任務
- ✅ 處理拒絕函數中的錯誤

### 3. Token 管理
- ✅ `clearTokens` - 清除本地存儲的 tokens

### 4. 401 錯誤處理
- ✅ `handle401` - 處理 401 錯誤並觸發刷新
- ✅ 並發 401 請求處理
- ✅ 刷新過程中的新請求處理

### 5. Token 刷新流程
- ✅ `handlerByRefreshAccessToken` - 主要刷新流程
- ✅ 重試限制達到時的處理
- ✅ 刷新成功後的請求重放
- ✅ 新 token 有 IP 時重置重試限制
- ✅ 新 token 無 IP 時維持重試限制
- ✅ 重放請求時的錯誤處理
- ✅ 刷新失敗且狀態碼為 401 時清除 tokens
- ✅ 刷新失敗且狀態碼非 401 時不清除 tokens
- ✅ 不同錯誤物件格式的處理
- ✅ 字符串錯誤的處理
- ✅ 重試限制遞減

### 6. 複雜場景測試
- ✅ 多個並發 401 請求的處理
- ✅ 佇列處理過程中新請求的處理

## 測試技術特點

### Mock 策略
- 使用 Vitest 的 `vi.mock()` 來模擬外部依賴
- Mock 了 `refreshToken`、`hasIP`、`removeLocalStorage` 函數
- 創建了 Axios 實例的 mock

### 錯誤處理測試
- 覆蓋了各種錯誤情況
- 測試了錯誤傳播和處理
- 驗證了控制台警告的抑制

### 併發測試
- 測試了多個同時進行的 401 請求
- 驗證了只觸發一次 token 刷新
- 確保所有請求都能正確重放

### 狀態管理測試
- 驗證了 Zustand store 的狀態變化
- 測試了狀態重置功能
- 確保狀態一致性

## 運行測試

```bash
npm test src/utils/authQueue/index.test.ts
```

## 測試結果

✅ 所有 22 個測試用例均通過
✅ 無編譯錯誤
✅ 類型安全
✅ 符合 ESLint 規範

## 覆蓋的邊界情況

1. **重試限制邊界**：測試了達到和未達到重試限制的情況
2. **並發處理**：確保多個並發請求只觸發一次刷新
3. **錯誤類型**：測試了不同格式的錯誤對象
4. **Token 格式**：測試了有無 IP 的 token
5. **狀態轉換**：測試了各種狀態之間的正確轉換

這個測試套件確保了 authQueue 模組在各種情況下的可靠性和正確性。
